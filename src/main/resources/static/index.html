<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeekæ™ºèƒ½é—®ç­”ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .chat-container {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .user-message .message-header {
            color: #764ba2;
        }

        .bot-message .message-header {
            color: #667eea;
        }

        .message-content {
            padding: 12px 15px;
            border-radius: 10px;
            word-wrap: break-word;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .user-message .message-content {
            background: #f3e5f5;
        }

        .bot-message .message-content {
            background: #e3f2fd;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #667eea;
            font-style: italic;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid #eee;
            background: white;
            display: flex;
            gap: 10px;
        }

        .question-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .question-input:focus {
            border-color: #667eea;
        }

        .send-button {
            padding: 12px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .send-button:hover:not(:disabled) {
            background: #5a67d8;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .cancel-button {
            padding: 12px 25px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cancel-button:hover {
            background: #ff5252;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.5);
        }

        .welcome-message {
            text-align: center;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DeepSeekæ™ºèƒ½é—®ç­”ç³»ç»Ÿ</h1>
            <p>åŸºäºå¤§æ¨¡å‹çš„æ™ºèƒ½é—®ç­”åŠ©æ‰‹</p>
        </div>
        
        <div id="chatContainer" class="chat-container">
            <div class="message bot-message">
                <div class="message-header">ğŸ¤– AIåŠ©æ‰‹</div>
                <div class="message-content welcome-message">
                    æ¬¢è¿ä½¿ç”¨DeepSeekæ™ºèƒ½é—®ç­”ç³»ç»Ÿï¼è¯·è¾“å…¥æ‚¨çš„é—®é¢˜å¼€å§‹å¯¹è¯ã€‚
                </div>
            </div>
        </div>
        
        <div class="input-container">
            <input 
                type="text" 
                id="questionInput" 
                class="question-input" 
                placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                autocomplete="off"
            >
            <button id="actionButton" class="send-button">
                <span>ğŸ“¤</span> å‘é€
            </button>
        </div>
    </div>

    <script>
        class QAInterface {
            constructor() {
                this.chatContainer = document.getElementById('chatContainer');
                this.questionInput = document.getElementById('questionInput');
                this.actionButton = document.getElementById('actionButton');
                
                this.isLoading = false;
                this.abortController = null;
                
                this.initEventListeners();
            }
            
            initEventListeners() {
                // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                this.actionButton.addEventListener('click', () => {
                    if (this.isLoading) {
                        this.cancelRequest();
                    } else {
                        this.sendQuestion();
                    }
                });
                
                // å›è½¦é”®å‘é€
                this.questionInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (!this.isLoading) {
                            this.sendQuestion();
                        }
                    }
                });
            }
            
            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
            addMessage(text, isBot = false, isTyping = false, isError = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isBot ? 'bot-message' : 'user-message'}`;
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                headerDiv.textContent = isBot ? 'ğŸ¤– AIåŠ©æ‰‹' : 'ğŸ‘¤ æ‚¨';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                if (isTyping) {
                    contentDiv.innerHTML = `
                        <div class="typing-indicator">
                            <div class="loading-spinner"></div>
                            æ­£åœ¨æ€è€ƒä¸­...
                        </div>
                    `;
                } else if (isError) {
                    contentDiv.className += ' error-message';
                    contentDiv.innerHTML = `
                        <div style="color: #ff6b6b; font-weight: bold;">âŒ é”™è¯¯ï¼š</div>
                        <div>${text}</div>
                        ${this.isLoading ? '' : '<button class="retry-button" onclick="window.qaInterface.retryLastQuestion()">ğŸ”„ é‡è¯•</button>'}
                    `;
                } else {
                    contentDiv.textContent = text;
                }
                
                messageDiv.appendChild(headerDiv);
                messageDiv.appendChild(contentDiv);
                
                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                return messageDiv;
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom() {
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }
            
            // å‘é€é—®é¢˜
            async sendQuestion() {
                const question = this.questionInput.value.trim();
                if (!question || this.isLoading) return;
                
                // ä¿å­˜æœ€åä¸€ä¸ªé—®é¢˜ç”¨äºé‡è¯•
                this.lastQuestion = question;
                
                // æ·»åŠ ç”¨æˆ·é—®é¢˜
                this.addMessage(question, false);
                this.questionInput.value = '';
                
                // è®¾ç½®åŠ è½½çŠ¶æ€
                this.isLoading = true;
                this.updateActionButton(true);
                
                // æ·»åŠ AIå›å¤å ä½ç¬¦
                const botMessageElement = this.addMessage('', true, true);
                
                try {
                    // åˆ›å»ºAbortControllerç”¨äºå–æ¶ˆè¯·æ±‚
                    this.abortController = new AbortController();
                    
                    // ä½¿ç”¨æµå¼API
                    const response = await fetch('/api/v1/qa/chat/stream', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ question: question }),
                        signal: this.abortController.signal
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                    }
                    
                    // æ£€æŸ¥Content-Typeå¤´
                    const contentType = response.headers.get('Content-Type');
                    console.log('Response Content-Type:', contentType);
                    if (!contentType || !contentType.includes('text/event-stream')) {
                        throw new Error('æœåŠ¡å™¨å“åº”ä¸æ˜¯æµå¼æ ¼å¼ï¼Œè¯·æ£€æŸ¥APIç«¯ç‚¹æ˜¯å¦æ­£ç¡®');
                    }
                    
                    // å¤„ç†æµå¼å“åº”
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let answer = '';
                    const contentDiv = botMessageElement.querySelector('.message-content');
                    
                    // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    contentDiv.innerHTML = '';
                    
                    // ç¼“å†²åŒºç”¨äºå¤„ç†åˆ†å—æ•°æ®
                    let buffer = '';
                    
                    // è¯»å–æµæ•°æ®
                    let chunkCount = 0;
                    while (true) {
                        const { done, value } = await reader.read();
                        console.log(`Chunk ${++chunkCount}: done=${done}`, value);
                        
                        if (done) {
                            console.log('Stream completed');
                            break;
                        }
                        
                        // è§£ç æ•°æ®å¹¶æ·»åŠ åˆ°ç¼“å†²åŒº
                        const decodedValue = decoder.decode(value, { stream: true });
                        buffer += decodedValue;
                        console.log('Decoded value:', decodedValue);
                        console.log('Buffer content:', buffer);
                        
                        // æŒ‰è¡Œåˆ†å‰²æ•°æ®ï¼Œå¤„ç†å®Œæ•´çš„è¡Œ
                        const lines = buffer.split('\n');
                        console.log('Lines after split:', lines);
                        
                        // ä¿ç•™æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„è¡Œåœ¨ç¼“å†²åŒºä¸­
                        buffer = lines.pop() || '';
                        console.log('Remaining buffer:', buffer);
                        
                        // å¤„ç†å®Œæ•´çš„è¡Œ
                        for (const line of lines) {
                            console.log('Processing line:', line);
                            if (line.startsWith('data:')) {
                                const data = line.slice(5);
                                console.log('Data extracted:', data);
                                
                                // æ£€æŸ¥æ˜¯å¦ä¸ºæµç»“æŸæ ‡è®°
                                if (data === '[DONE]') {
                                    console.log('Stream end marker found');
                                    // æµç»“æŸï¼Œç»§ç»­å¤„ç†å…¶ä»–è¡Œ
                                    continue;
                                }
                                
                                try {
                                    const jsonData = JSON.parse(data);
                                    console.log('Parsed JSON data:', jsonData);
                                    
                                    // æ­£ç¡®å¤„ç†DeepSeek APIçš„æµå¼å“åº”æ ¼å¼
                                    const content = jsonData.choices?.[0]?.delta?.content;
                                    console.log('Content from delta:', content);
                                    
                                    if (content) {
                                        answer += content;
                                        console.log('Updated answer:', answer);
                                        // ä½¿ç”¨textContentè€Œä¸æ˜¯innerHTMLä»¥é˜²æ­¢XSSæ”»å‡»
                                        contentDiv.textContent = answer;
                                        this.scrollToBottom();
                                    } else {
                                        console.log('No content in delta:', jsonData);
                                    }
                                    
                                    // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
                                    if (jsonData.error) {
                                        console.log('Error in API response:', jsonData.error);
                                        throw new Error(jsonData.error.message || 'APIè¿”å›é”™è¯¯');
                                    }
                                } catch (e) {
                                    // å¦‚æœè§£æå¤±è´¥ä½†ä¸æ˜¯è¯­æ³•é”™è¯¯ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
                                    if (!(e instanceof SyntaxError)) {
                                        throw e;
                                    }
                                    // å¯¹äºJSONè¯­æ³•é”™è¯¯ï¼Œæˆ‘ä»¬è®°å½•æ—¥å¿—ä½†ç»§ç»­å¤„ç†
                                    console.warn('JSONè§£æè­¦å‘Š:', e, 'åŸå§‹æ•°æ®:', data);
                                }
                            } else if (line.trim() !== '') {
                                console.log('Non-data line ignored:', line);
                            }
                        }
                    }
                    
                    // å¤„ç†ç¼“å†²åŒºä¸­å‰©ä½™çš„æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
                    console.log('Final buffer processing:', buffer);
                    if (buffer && buffer.startsWith('data: ')) {
                        const data = buffer.slice(6);
                        console.log('Final buffer data:', data);
                        if (data !== '[DONE]') {
                            try {
                                const jsonData = JSON.parse(data);
                                console.log('Parsed final buffer JSON:', jsonData);
                                
                                // æ­£ç¡®å¤„ç†DeepSeek APIçš„æµå¼å“åº”æ ¼å¼
                                const content = jsonData.choices?.[0]?.delta?.content;
                                console.log('Final content from delta:', content);
                                
                                if (content) {
                                    answer += content;
                                    console.log('Final updated answer:', answer);
                                    contentDiv.textContent = answer;
                                    this.scrollToBottom();
                                } else {
                                    console.log('No content in final delta:', jsonData);
                                }
                            } catch (e) {
                                if (!(e instanceof SyntaxError)) {
                                    throw e;
                                }
                                console.warn('JSONè§£æè­¦å‘Š:', e, 'åŸå§‹æ•°æ®:', data);
                            }
                        }
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹è¿”å›
                    console.log('Final answer content:', answer);
                    console.log('Answer length:', answer.length);
                    if (!answer) {
                        console.log('No content received from API, showing error message');
                        contentDiv.textContent = 'APIæ²¡æœ‰è¿”å›æœ‰æ•ˆå†…å®¹ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                    }
                } catch (error) {
                    console.error('Error in sendQuestion:', error);
                    if (error.name === 'AbortError') {
                        // è¯·æ±‚è¢«å–æ¶ˆ
                        const contentDiv = botMessageElement.querySelector('.message-content');
                        contentDiv.innerHTML = `
                            <div style="color: #ff6b6b;">å›ç­”å·²è¢«ç”¨æˆ·å–æ¶ˆ</div>
                        `;
                    } else if (error.message && error.message.includes('HTTPé”™è¯¯: 400')) {
                        // 400é”™è¯¯å¤„ç†
                        const contentDiv = botMessageElement.querySelector('.message-content');
                        contentDiv.innerHTML = `
                            <div style="color: #ff6b6b; font-weight: bold;">âŒ è¯·æ±‚é”™è¯¯ï¼š</div>
                            <div>æ‚¨çš„è¯·æ±‚æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥åé‡è¯•ã€‚</div>
                            <button class="retry-button" onclick="window.qaInterface.retryLastQuestion()">ğŸ”„ é‡è¯•</button>
                        `;
                    } else if (error.message && error.message.includes('HTTPé”™è¯¯: 500')) {
                        // 500é”™è¯¯å¤„ç†
                        const contentDiv = botMessageElement.querySelector('.message-content');
                        contentDiv.innerHTML = `
                            <div style="color: #ff6b6b; font-weight: bold;">âŒ æœåŠ¡å™¨é”™è¯¯ï¼š</div>
                            <div>æœåŠ¡å™¨å†…éƒ¨å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚</div>
                            <button class="retry-button" onclick="window.qaInterface.retryLastQuestion()">ğŸ”„ é‡è¯•</button>
                        `;
                    } else if (error.message && error.message.includes('HTTPé”™è¯¯: 404')) {
                        // 404é”™è¯¯å¤„ç†
                        const contentDiv = botMessageElement.querySelector('.message-content');
                        contentDiv.innerHTML = `
                            <div style="color: #ff6b6b; font-weight: bold;">âŒ æ¥å£é”™è¯¯ï¼š</div>
                            <div>è¯·æ±‚çš„æ¥å£ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥APIåœ°å€æ˜¯å¦æ­£ç¡®ã€‚</div>
                            <button class="retry-button" onclick="window.qaInterface.retryLastQuestion()">ğŸ”„ é‡è¯•</button>
                        `;
                    } else if (error.message && error.message.includes('HTTPé”™è¯¯:')) {
                        // å…¶ä»–HTTPé”™è¯¯
                        const contentDiv = botMessageElement.querySelector('.message-content');
                        const statusMatch = error.message.match(/HTTPé”™è¯¯: (\d+)/);
                        const statusCode = statusMatch ? statusMatch[1] : 'æœªçŸ¥';
                        contentDiv.innerHTML = `
                            <div style="color: #ff6b6b; font-weight: bold;">âŒ HTTPé”™è¯¯ (${statusCode})ï¼š</div>
                            <div>è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</div>
                            <button class="retry-button" onclick="window.qaInterface.retryLastQuestion()">ğŸ”„ é‡è¯•</button>
                        `;
                    } else if (error.message && error.message.includes('æœåŠ¡å™¨å“åº”ä¸æ˜¯æµå¼æ ¼å¼')) {
                        // å“åº”æ ¼å¼é”™è¯¯
                        const contentDiv = botMessageElement.querySelector('.message-content');
                        contentDiv.innerHTML = `
                            <div style="color: #ff6b6b; font-weight: bold;">âŒ å“åº”æ ¼å¼é”™è¯¯ï¼š</div>
                            <div>æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚</div>
                            <button class="retry-button" onclick="window.qaInterface.retryLastQuestion()">ğŸ”„ é‡è¯•</button>
                        `;
                    } else {
                        // å…¶ä»–é”™è¯¯
                        const contentDiv = botMessageElement.querySelector('.message-content');
                        contentDiv.innerHTML = `
                            <div style="color: #ff6b6b; font-weight: bold;">âŒ é”™è¯¯ï¼š</div>
                            <div>${error.message || 'è·å–å›ç­”æ—¶å‡ºç°æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚'}</div>
                            <button class="retry-button" onclick="window.qaInterface.retryLastQuestion()">ğŸ”„ é‡è¯•</button>
                        `;
                    }
                } finally {
                    this.isLoading = false;
                    this.updateActionButton(false);
                    this.abortController = null;
                }
            }
            
            // é‡è¯•ä¸Šä¸€ä¸ªé—®é¢˜
            retryLastQuestion() {
                if (this.lastQuestion && !this.isLoading) {
                    // æ¸…é™¤æœ€åä¸€ä¸ªé”™è¯¯æ¶ˆæ¯
                    const lastBotMessage = this.chatContainer.querySelector('.message.bot-message:last-child');
                    if (lastBotMessage) {
                        lastBotMessage.remove();
                    }
                    
                    // é‡æ–°å‘é€é—®é¢˜
                    this.questionInput.value = this.lastQuestion;
                    this.sendQuestion();
                }
            }
            
            // å–æ¶ˆè¯·æ±‚
            cancelRequest() {
                if (this.isLoading && this.abortController) {
                    this.abortController.abort();
                }
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateActionButton(isLoading) {
                if (isLoading) {
                    this.actionButton.className = 'cancel-button';
                    this.actionButton.innerHTML = '<span>â¹ï¸</span> åœæ­¢å›ç­”';
                } else {
                    this.actionButton.className = 'send-button';
                    this.actionButton.innerHTML = '<span>ğŸ“¤</span> å‘é€';
                }
                
                this.questionInput.disabled = isLoading;
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            window.qaInterface = new QAInterface();
        });
    </script>
</body>
</html>